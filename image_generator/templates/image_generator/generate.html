
{% extends "base.html" %}
{% load static %}

{% block title %}Image Prompt - HydrogenArts{% endblock %}

{% block content %}
<div class="container-fluid main-container">
    <div class="row align-items-stretch flex-lg-nowrap justify-content-between" style="min-height: 80vh;">
        <!-- Prompt Pane Centered with Further Rightward Offset -->
        <div class="col-12 col-lg-5 offset-lg-2 d-flex justify-content-center mb-4 mb-lg-0 order-lg-1" id="prompt-pane">
            <div class="prompt-card flex-fill d-flex flex-column justify-content-center align-items-center" style="min-height: 100%; min-width: 340px;">
                <h1 class="dialog-heading mb-4">Generate Your Masterpiece</h1>
                <form id="prompt-form" method="post" class="w-100" style="max-width: 480px;">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea class="form-control" id="prompt" name="prompt" rows="7" placeholder="e.g., A futuristic city skyline at sunset, with flying cars and neon lights, hyperrealistic, 8k" required></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-magic"></i> Generate Image
                        </button>
                    </div>
                </form>
                <div id="loading-indicator" class="mt-4 text-center" style="display:none;">
                    <img src="/media/pulse-loader.svg" style="width:64px;height:64px;display:block;margin:0 auto 1rem auto;">
                    <div style="font-weight:700;font-size:1.2rem;color:#a3e3ff;letter-spacing:1px;">Your Image is Generating...</div>
                </div>
                {% if error %}
                    <div class="alert alert-danger mt-4">{{ error }}</div>
                {% endif %}
            </div>
        </div>
        <!-- Result Pane at Right End -->
        <div class="col-12 col-lg-4 d-flex justify-content-center order-lg-2" id="result-pane">
            <div class="result-pane flex-fill d-flex flex-column align-items-center justify-content-center position-relative" style="min-height: 100%; min-width: 340px; max-width: 480px;">
                <div class="result-header w-100 d-flex align-items-center justify-content-between mb-3 px-3" style="min-height: 48px;">
                    <h3 class="dialog-heading mb-0">Result</h3>
                </div>
                <div class="generated-image-container flex-fill align-self-stretch w-100 d-flex flex-column justify-content-center" id="result-container" style="min-height: 250px;">
                    <div id="result-image-pane" class="image-pane"></div>
                    <h3 class="dialog-heading text-center mt-3" id="result-title" style="opacity:0.7; font-size:1.1rem;">Your Creation will appear here</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
.dialog-heading {
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 900;
    font-size: 2rem;
    letter-spacing: 2px;
    color: #fff;
    background: linear-gradient(90deg, #fff 10%, #a3e3ff 40%, #e0b3ff 70%, #fff 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 2px 16px #a3e3ff33;
    margin-bottom: 1.2rem;
}
.prompt-card {
    position: relative;
    background: rgba(255,255,255,0.10);
    border: 1.5px solid rgba(255,255,255,0.18);
    border-radius: 28px;
    padding: 2.7rem 2.2rem 2.2rem 2.2rem;
    box-shadow: 0 8px 40px 0 rgba(163, 227, 255, 0.10), 0 1.5px 8px 0 rgba(224, 179, 255, 0.08);
    backdrop-filter: blur(18px) saturate(180%);
    -webkit-backdrop-filter: blur(18px) saturate(180%);
    margin-bottom: 2.2rem;
    transition: box-shadow 0.2s;
    overflow: hidden;
    min-height: 420px;
}
.prompt-card::before {
    content: "";
    position: absolute;
    top: -40%;
    left: -30%;
    width: 160%;
    height: 180%;
    background: radial-gradient(circle at 30% 30%, rgba(163,227,255,0.18) 0%, rgba(224,179,255,0.12) 40%, transparent 80%),
                linear-gradient(120deg, rgba(255,255,255,0.08) 0%, rgba(163,227,255,0.10) 100%);
    filter: blur(18px) saturate(180%);
    z-index: 0;
}
.prompt-card > * { position: relative; z-index: 1; }
.prompt-card:hover { box-shadow: 0 16px 48px 0 rgba(163, 227, 255, 0.18); }

.result-pane {
    background: rgba(255,255,255,0.13);
    border: 1.5px solid rgba(163,227,255,0.13);
    border-radius: 28px;
    box-shadow: 0 8px 40px 0 rgba(163, 227, 255, 0.10), 0 1.5px 8px 0 rgba(224, 179, 255, 0.08);
    backdrop-filter: blur(18px) saturate(180%);
    -webkit-backdrop-filter: blur(18px) saturate(180%);
    margin-bottom: 2.2rem;
    min-height: 320px;
    max-width: 480px;
    min-width: 340px;
    padding: 1.5rem 1.2rem 1.2rem 1.2rem;
    position: relative;
}
.result-header {
    border-bottom: 1.5px solid rgba(163,227,255,0.13);
    margin-bottom: 1.2rem;
}
.generated-image-container {
    min-height: 250px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.image-pane {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: center;
    align-items: flex-start;
    min-height: 180px;
}
.generated-thumb {
    width: 250px;
    height: 175px;
    object-fit: cover;
    border-radius: 18px;
    border: 2.5px solid #e0b3ff;
    box-shadow: 0 4px 16px rgba(163, 227, 255, 0.18);
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.2s;
}
.generated-thumb:hover {
    box-shadow: 0 8px 32px rgba(224, 179, 255, 0.22);
    transform: scale(1.04);
}
#image-popup {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(30,34,54,0.55);
    backdrop-filter: blur(8px) saturate(180%);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}
#image-popup.active {
    display: flex;
}
#popup-content {
    background: rgba(255,255,255,0.10);
    border-radius: 22px;
    padding: 2rem;
    box-shadow: 0 8px 40px 0 rgba(163, 227, 255, 0.18);
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}
#popup-content img {
    max-width: 70vw;
    max-height: 70vh;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(224, 179, 255, 0.22);
}
#popup-close {
    position: absolute;
    top: 12px;
    right: 18px;
    font-size: 2rem;
    color: #fff;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 2;
    text-shadow: 0 2px 16px #a3e3ff33;
}
.form-control {
    background: rgba(36, 40, 60, 0.13);
    border: 1.2px solid rgba(163, 227, 255, 0.10);
    color: #e6eaf3;
    border-radius: 14px;
    padding: 1.1rem 1.3rem;
    font-size: 1.13rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(163, 227, 255, 0.05);
    backdrop-filter: blur(6px) saturate(160%);
}
.form-control:focus {
    background: rgba(80, 200, 255, 0.09);
    color: #fff;
    border-color: #a3e3ff;
    box-shadow: 0 0 0 0.13rem #a3e3ff22;
}
::placeholder {
    color: #b3c7e6cc;
    opacity: 1;
}
/* Neon Button Styles */
.btn, button, input[type="submit"], input[type="button"] {
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 700;
    font-size: 1.08rem;
    border: none;
    border-radius: 14px;
    padding: 0.85rem 2.1rem;
    background: linear-gradient(90deg, #0fffc1 0%, #3b82f6 60%, #e0b3ff 100%);
    color: #fff;
    box-shadow: 0 0 8px 0 #0fffc1cc, 0 0 24px 0 #3b82f666, 0 0 0px 0 #e0b3ff44;
    text-shadow: 0 0 8px #0fffc1cc, 0 0 2px #3b82f6cc;
    transition: box-shadow 0.18s, background 0.18s, color 0.18s, transform 0.18s;
    outline: none;
    position: relative;
    z-index: 1;
    letter-spacing: 1px;
    cursor: pointer;
    overflow: hidden;
}
.btn:before, button:before, input[type="submit"]:before, input[type="button"]:before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 14px;
    background: linear-gradient(90deg, #0fffc1 0%, #3b82f6 60%, #e0b3ff 100%);
    opacity: 0.18;
    filter: blur(8px);
    z-index: -1;
    transition: opacity 0.18s;
}
.btn:hover, button:hover, input[type="submit"]:hover, input[type="button"]:hover {
    background: linear-gradient(90deg, #3b82f6 0%, #0fffc1 60%, #e0b3ff 100%);
    color: #fff;
    box-shadow: 0 0 16px 2px #0fffc1cc, 0 0 32px 4px #3b82f6cc, 0 0 8px 2px #e0b3ff99;
    transform: translateY(-2px) scale(1.03);
}
.btn:active, button:active, input[type="submit"]:active, input[type="button"]:active {
    background: linear-gradient(90deg, #0fffc1 0%, #e0b3ff 100%);
    color: #fff;
    box-shadow: 0 0 8px 0 #0fffc1cc, 0 0 16px 0 #e0b3ff99;
    transform: scale(0.98);
}
.btn:focus, button:focus, input[type="submit"]:focus, input[type="button"]:focus {
    outline: 2px solid #0fffc1;
    outline-offset: 2px;
}
</style>

<div id="image-popup">
    <div id="popup-content">
        <button id="popup-close">&times;</button>
        <img id="popup-img" src="" alt="Full Size Image">
    </div>
</div>

<script>
// Glassmorphism async polling logic
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('prompt-form');
    const loading = document.getElementById('loading-indicator');
    const resultContainer = document.getElementById('result-container');
    const resultTitle = document.getElementById('result-title');
    const resultImagePane = document.getElementById('result-image-pane');
    let pollIntervalId = null;
    function showImage(imgPath) {
        // Always prefix with /media/ if not already present
        if (!imgPath.startsWith('/media/')) {
            imgPath = '/media/' + imgPath.replace(/^\/+/,'');
        }
        resultTitle.textContent = 'Your Creation';
        resultContainer.style.opacity = 1;
        // Show as thumbnail in pane
        resultImagePane.innerHTML = `<img src="${imgPath}" class="generated-thumb" alt="Generated Image">`;
        // Add click event for popup
        const thumb = resultImagePane.querySelector('.generated-thumb');
        if (thumb) {
            thumb.addEventListener('click', function() {
                document.getElementById('popup-img').src = imgPath;
                document.getElementById('image-popup').classList.add('active');
            });
        }
    }
    function showError(msg) {
        resultTitle.textContent = 'Error';
        resultImagePane.innerHTML = `<div class='alert alert-danger mt-3'>${msg}</div>`;
    }
    function showWaiting() {
        resultTitle.textContent = 'Your Creation will appear here';
        resultImagePane.innerHTML = '';
        resultContainer.style.opacity = 0.5;
    }
    function pollStatus(requestId) {
        loading.style.display = 'block';
        resultContainer.style.opacity = 0.5;
        pollIntervalId = setInterval(() => {
            fetch(`?request_id=${requestId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'done' && data.image_path) {
                        clearInterval(pollIntervalId);
                        loading.style.display = 'none';
                        let imgPath = data.image_path.replace(/^\/+/,'');
                        showImage(imgPath);
                    } else if (data.status === 'failed' || data.status === 'error') {
                        clearInterval(pollIntervalId);
                        loading.style.display = 'none';
                        showError('Image generation failed. Please try again.');
                    } else {
                        loading.style.display = 'block';
                        showWaiting();
                    }
                })
                .catch(() => {
                    clearInterval(pollIntervalId);
                    loading.style.display = 'none';
                    showError('An error occurred. Please try again.');
                });
        }, 1000);
    }
    if (form) {
        // Remove any previous event listeners (precaution for hot reloads)
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            loading.style.display = 'block';
            showWaiting();
            const formData = new FormData(form);
            fetch('', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            })
            .then(response => response.json())
            .then(function(data) {
                if (data.request_id) {
                    pollStatus(data.request_id);
                } else if (data.error) {
                    loading.style.display = 'none';
                    showError(data.error);
                }
            })
            .catch(function() {
                loading.style.display = 'none';
                showError('An error occurred. Please try again.');
            });
        });
    }
    // Popup close logic
    document.getElementById('popup-close').addEventListener('click', function() {
        document.getElementById('image-popup').classList.remove('active');
        document.getElementById('popup-img').src = '';
    });
    document.getElementById('image-popup').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            document.getElementById('popup-img').src = '';
        }
    });
});
</script>
{% endblock %}
